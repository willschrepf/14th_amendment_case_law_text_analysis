---
title: "dictionary_analysis"
author: "Will Schrepferman"
date: "1/24/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE)
library("tidyverse")
library("rjson")
library("tidyjson")
library("glue")
library("gt")
library("skimr")
library("openxlsx")
library("tidytext")
library("SnowballC")
library("rvest")

#     Be prepared to re-run existing analyses with a slightly modified corpus in the next couple of weeks (initial input terms and date range) 

#    DONE - TODO: For cases with the same name (like Swann, Briggs), note the ID number so we can tell if it is the appellate or district court decision 

#    DONE - TODO: For the cases lists, expand from 25 to 50 

#    Let's begin thinking about ways to look for words we might have missed (word embeddings, word2vec) 

#    DONE - TODO: For the top courts by dictionary richness, get me the list of most representative cases within those courts 

#    TODO: We want to begin thinking about metadata (region, judge - look on Court Listener API at which variables are attached to our cases; I know there's a lot of missing data); people will inevitably ask "what predicts existence of your terms?" I personally am less interested in that question, and don't think we'll get a super statistically rigorous answer, but we need to have some nod to it (even if it's just like we tried X and Y and they don't work) 

#    I want to do the same analyses with a view more terms - "briggs", "color blind, colorblind." When we expand the corpus to present day, we are also going to be looking for a series of words having to do with gay rights, gay marriage, same-sex, etc. (seeing how the gay rights movement borrowed the concept actual equality from the CRM), so just keep that in mind 

#    And then moving ahead, as we talked about, we're going to want to think about how to identify new ideas emerging in the caselaw (topic modeling, work frequencies year over year) and sentiment analysis

```

## Introduction

Using our originally-pulled corpus of around 7,000 cases, I used Jimmy's dictionary of terms to analyze it both as a complete set and on an individual-term basis.

```{r read_data, include = FALSE}

# All data written to csv's from basic_stats cleaning and analysis

corpus_relevant <- read_csv("full_corpus.csv")

corpus_relevant_modified <- read_csv("full_corpus.csv") %>%
  mutate(cleaned_text = str_replace_all(tolower(clean_text), "[[:punct:]]", " ")) %>%
  select(id, slug, year, judges, federal_cite, cleaned_text, doc_length_post_clean, exact_date, resource_uri, federal_cite)

dictionary_original <- read_csv("modified_dictionary.csv") %>%
  mutate(word = str_replace_all(tolower(value), "[[:punct:]]", " ")) %>%
  select(word)

dictionary_stemmed <- read_csv("stemmed_dictionary.csv")

dictionary_occurrences <- read_csv("final_dictionary_occurences_all.csv") %>%
  left_join(corpus_relevant_modified, by = c("id", "slug", "year"))
```

Here is the raw dictionary of terms we looked for; for reference, terms were stemmed and lemmatized so that variants of the same term or phrase could be considered as one. Additionally, I removed stop words from all terms (common, non-substantive words) for ease of analysis with the full corpus.

```{r display_terms}

dictionary_original$id <- seq.int(nrow(dictionary_original))
dictionary_stemmed$id <- seq.int(nrow(dictionary_stemmed))


joined_dictionary <- full_join(dictionary_original, dictionary_stemmed, by = "id") %>%
  select(word, value) %>%
  gt() %>%
  tab_header(title = "Original versus Stemmed Dictionary Terms") %>%
  cols_label(word = "Original Term", value = "Stemmed Term")

joined_dictionary
```

## Full Dictionary over Time

Next, I wrote a customized script to track the occurrences of variable-length phrases in a corpus (amazingly, this did not appear to exist in any package or Stack Overflow post I could find). I ran it with our dictionary and the full relevant corpus (specified as 1950-1974 per Jimmy's specifications). 


First, I did just a raw count of the dictionary occurring as a set over time:

```{r overall_time_series}
dictionary_occurrences_overall_time_series <- dictionary_occurrences %>%
  group_by(year) %>%
  summarise(count = n()) %>%
  ggplot(aes(x = year, y = count)) +
  geom_line() +
  labs(title = "Occurrence of Dictionary Over Time - Raw Count", x = "Year", y = "Usage Count")


dictionary_occurrences_overall_time_series
  
```


However, this raw count doesn't paint the full picture, so I also did a *relative* count of terms. This is simply the percentage of terms in a given year that were terms from our dictionary.


```{r relative_time_series}

dictionary_occurrences_raw <- dictionary_occurrences %>%
  group_by(year) %>%
  summarise(count_dict = n())

overall_occurrences <- corpus_relevant %>%
  unnest_tokens(word, clean_text) %>%
  group_by(year) %>%
  summarise(count_ovr = n())

dictionary_occurrences_relative_time_series <- dictionary_occurrences_raw %>%
  right_join(overall_occurrences, by = "year") %>%
  mutate(rel_occurrences = 100*(count_dict/count_ovr)) %>%
  ggplot(aes(x = year, y = rel_occurrences)) +
  geom_line() +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) +
  labs(title = "Occurrence of Dictionary Over Time - Relative Count", subtitle = "Dictionary Use Counted as Percentage of Total Terms per Year", x = "Year", y = "Dictionary Percentage Use")

dictionary_occurrences_relative_time_series

```


## Overall Rankings

Next, I ran some quick rankings. First up is a ranking of terms by overall counts:

```{r term_rankings}
dictionary_occurrences %>%
  group_by(phrase) %>%
  summarise(count = n()) %>%
  arrange(-count) %>%
  gt() %>%
  tab_header(title = "Top Terms") %>%
  cols_label(phrase = "Term", count = "Total Uses of Dictionary Terms")
```

Then, the top 50 cases with the highest dictionary term counts:

```{r case_counts}
dictionary_occurrences %>%
  select(slug, id, federal_cite) %>%
  group_by(id) %>%
  summarise(count = n(), slug = max(slug), federal_cite = max(federal_cite)) %>%
  select(slug, id, federal_cite, count) %>%
  arrange(-count) %>%
  head(50) %>%
  gt() %>%
  tab_header(title = "Top Cases - By Raw Counts") %>%
  cols_label(id = "Case ID", slug = "Case", federal_cite = "Federal Citation", count = "Total Uses of Dictionary Terms")
```


Then, the top 50 most frequent cases in terms of dictionary richness (percentage of dictionary words in its overall word count):

```{r case_richness}
dictionary_cases <- dictionary_occurrences %>%
  group_by(id) %>%
  summarise(count = n(), slug = max(slug), federal_cite = max(federal_cite)) %>%
  select(slug, id, federal_cite, count)

overall_cases <- corpus_relevant %>%
  select(slug, id, doc_length_post_clean)

case_richness <- dictionary_cases %>%
  right_join(overall_cases, by = "id") %>%
  mutate(slug = slug.x) %>%
  mutate(richness = 100*(count/doc_length_post_clean)) %>%
  arrange(-richness) %>%
  select(slug, id, federal_cite, richness) %>%
  head(50) %>%
  gt() %>%
  tab_header(title = "Top Cases - By Dictionary Richness") %>%
  cols_label(slug = "Case", id = "Case ID", federal_cite = "Federal Citation", richness = "Percent of Dictionary Terms in Case")
  

case_richness
  
```


Next, the top 50 courts with the highest dictionary term counts:

```{r court_counts}
dictionary_occurrences %>%
  group_by(court) %>%
  summarise(count = n()) %>%
  arrange(-count) %>%
  head(50) %>%
  gt() %>%
  tab_header(title = "Top Courts Using Dictionary Terms - By Raw Counts") %>%
  cols_label(court = "Court", count = "Total Uses of Dictionary Terms")
```


And the top 50 courts in terms of dictionary richness (percentage of dictionary words across all of a court's text):

```{r court_richness}
dictionary_courts <- dictionary_occurrences %>%
  group_by(court) %>%
  summarise(count_dict = n())

overall_courts <- corpus_relevant %>%
  select(court, doc_length_post_clean) %>%
  group_by(court) %>%
  summarise(count = sum(doc_length_post_clean))

court_richness <- dictionary_courts %>%
  right_join(overall_courts, by = "court") %>%
  mutate(richness = 100*(count_dict/count)) %>%
  arrange(-richness) %>%
  select(court, richness) %>%
  head(50)

court_richness  %>%
  gt() %>%
  tab_header(title = "Top Courts - By Dictionary Richness") %>%
  cols_label(court = "Court", richness = "Percent of Dictionary Terms for all Cases")


```
Additionally, here are the 5 richest individual cases from the 25 richest courts. It may be worthwhile for further analysis to include a filter of 'at least X cases must be present in a court for it to be considered.'
```{r richest_court_cases}

case_richness_overall <- dictionary_cases %>%
  right_join(corpus_relevant, by = c("id", "federal_cite")) %>%
  mutate(slug = slug.x) %>%
  mutate(richness = 100*(count/doc_length_post_clean)) %>%
  select(id, slug, count, doc_length_post_clean, richness, year, court, judges, federal_cite, resource_uri) %>%
  head(690)

richest_courts <-court_richness %>%
  select(court)

# for some reason, this for loop doesn't work. going for a manual solution

for(i in 1:25){
  court_in_question <- richest_courts[[1]][i]
  
  case_richness_in_question <- case_richness_overall %>%
    filter(court == court_in_question) %>%
    select(id, slug, year, richness) %>%
    arrange(-richness) %>%
    head(5) %>%
    gt() %>%
    tab_header(title = paste("Top Cases - ", court_in_question)) %>%
    cols_label(id = "ID", slug = "slug", year = "Year", richness = "Richness")
    
  case_richness_in_question
}

court_in_question <- richest_courts[[1]][1]
case_richness_in_question <- case_richness_overall %>%
    filter(court == court_in_question) %>%
    select(id, federal_cite, slug, year, richness) %>%
    arrange(-richness) %>%
    head(5) %>%
    gt() %>%
    tab_header(title = paste("Top Cases - ", court_in_question)) %>%
    cols_label(id = "ID", federal_cite = "Federal Citation", slug = "slug", year = "Year", richness = "Richness")
case_richness_in_question

court_in_question <- richest_courts[[1]][2]
case_richness_in_question <- case_richness_overall %>%
    filter(court == court_in_question) %>%
    select(id, federal_cite, slug, year, richness) %>%
    arrange(-richness) %>%
    head(5) %>%
    gt() %>%
    tab_header(title = paste("Top Cases - ", court_in_question)) %>%
    cols_label(id = "ID", federal_cite = "Federal Citation", slug = "slug", year = "Year", richness = "Richness")
case_richness_in_question

court_in_question <- richest_courts[[1]][3]
case_richness_in_question <- case_richness_overall %>%
    filter(court == court_in_question) %>%
    select(id, federal_cite, slug, year, richness) %>%
    arrange(-richness) %>%
    head(5) %>%
    gt() %>%
    tab_header(title = paste("Top Cases - ", court_in_question)) %>%
    cols_label(id = "ID", federal_cite = "Federal Citation", slug = "slug", year = "Year", richness = "Richness")
case_richness_in_question

court_in_question <- richest_courts[[1]][4]
case_richness_in_question <- case_richness_overall %>%
    filter(court == court_in_question) %>%
    select(id, federal_cite, slug, year, richness) %>%
    arrange(-richness) %>%
    head(5) %>%
    gt() %>%
    tab_header(title = paste("Top Cases - ", court_in_question)) %>%
    cols_label(id = "ID", federal_cite = "Federal Citation", slug = "slug", year = "Year", richness = "Richness")
case_richness_in_question

court_in_question <- richest_courts[[1]][5]
case_richness_in_question <- case_richness_overall %>%
    filter(court == court_in_question) %>%
    select(id, federal_cite, slug, year, richness) %>%
    arrange(-richness) %>%
    head(5) %>%
    gt() %>%
    tab_header(title = paste("Top Cases - ", court_in_question)) %>%
    cols_label(id = "ID", federal_cite = "Federal Citation", slug = "slug", year = "Year", richness = "Richness")
case_richness_in_question

court_in_question <- richest_courts[[1]][6]
case_richness_in_question <- case_richness_overall %>%
    filter(court == court_in_question) %>%
    select(id, federal_cite, slug, year, richness) %>%
    arrange(-richness) %>%
    head(5) %>%
    gt() %>%
    tab_header(title = paste("Top Cases - ", court_in_question)) %>%
    cols_label(id = "ID", federal_cite = "Federal Citation", slug = "slug", year = "Year", richness = "Richness")
case_richness_in_question

court_in_question <- richest_courts[[1]][7]
case_richness_in_question <- case_richness_overall %>%
    filter(court == court_in_question) %>%
    select(id, federal_cite, slug, year, richness) %>%
    arrange(-richness) %>%
    head(5) %>%
    gt() %>%
    tab_header(title = paste("Top Cases - ", court_in_question)) %>%
    cols_label(id = "ID", federal_cite = "Federal Citation", slug = "slug", year = "Year", richness = "Richness")
case_richness_in_question

court_in_question <- richest_courts[[1]][8]
case_richness_in_question <- case_richness_overall %>%
    filter(court == court_in_question) %>%
    select(id, federal_cite, slug, year, richness) %>%
    arrange(-richness) %>%
    head(5) %>%
    gt() %>%
    tab_header(title = paste("Top Cases - ", court_in_question)) %>%
    cols_label(id = "ID", federal_cite = "Federal Citation", slug = "slug", year = "Year", richness = "Richness")
case_richness_in_question

court_in_question <- richest_courts[[1]][9]
case_richness_in_question <- case_richness_overall %>%
    filter(court == court_in_question) %>%
    select(id, federal_cite, slug, year, richness) %>%
    arrange(-richness) %>%
    head(5) %>%
    gt() %>%
    tab_header(title = paste("Top Cases - ", court_in_question)) %>%
    cols_label(id = "ID", federal_cite = "Federal Citation", slug = "slug", year = "Year", richness = "Richness")
case_richness_in_question

court_in_question <- richest_courts[[1]][10]
case_richness_in_question <- case_richness_overall %>%
    filter(court == court_in_question) %>%
    select(id, federal_cite, slug, year, richness) %>%
    arrange(-richness) %>%
    head(5) %>%
    gt() %>%
    tab_header(title = paste("Top Cases - ", court_in_question)) %>%
    cols_label(id = "ID", federal_cite = "Federal Citation", slug = "slug", year = "Year", richness = "Richness")
case_richness_in_question

court_in_question <- richest_courts[[1]][11]
case_richness_in_question <- case_richness_overall %>%
    filter(court == court_in_question) %>%
    select(id, federal_cite, slug, year, richness) %>%
    arrange(-richness) %>%
    head(5) %>%
    gt() %>%
    tab_header(title = paste("Top Cases - ", court_in_question)) %>%
    cols_label(id = "ID", federal_cite = "Federal Citation", slug = "slug", year = "Year", richness = "Richness")
case_richness_in_question

court_in_question <- richest_courts[[1]][12]
case_richness_in_question <- case_richness_overall %>%
    filter(court == court_in_question) %>%
    select(id, federal_cite, slug, year, richness) %>%
    arrange(-richness) %>%
    head(5) %>%
    gt() %>%
    tab_header(title = paste("Top Cases - ", court_in_question)) %>%
    cols_label(id = "ID", federal_cite = "Federal Citation", slug = "slug", year = "Year", richness = "Richness")
case_richness_in_question

court_in_question <- richest_courts[[1]][13]
case_richness_in_question <- case_richness_overall %>%
    filter(court == court_in_question) %>%
    select(id, federal_cite, slug, year, richness) %>%
    arrange(-richness) %>%
    head(5) %>%
    gt() %>%
    tab_header(title = paste("Top Cases - ", court_in_question)) %>%
    cols_label(id = "ID", federal_cite = "Federal Citation", slug = "slug", year = "Year", richness = "Richness")
case_richness_in_question

court_in_question <- richest_courts[[1]][14]
case_richness_in_question <- case_richness_overall %>%
    filter(court == court_in_question) %>%
    select(id, federal_cite, slug, year, richness) %>%
    arrange(-richness) %>%
    head(5) %>%
    gt() %>%
    tab_header(title = paste("Top Cases - ", court_in_question)) %>%
    cols_label(id = "ID", federal_cite = "Federal Citation", slug = "slug", year = "Year", richness = "Richness")
case_richness_in_question

court_in_question <- richest_courts[[1]][15]
case_richness_in_question <- case_richness_overall %>%
    filter(court == court_in_question) %>%
    select(id, federal_cite, slug, year, richness) %>%
    arrange(-richness) %>%
    head(5) %>%
    gt() %>%
    tab_header(title = paste("Top Cases - ", court_in_question)) %>%
    cols_label(id = "ID", federal_cite = "Federal Citation", slug = "slug", year = "Year", richness = "Richness")
case_richness_in_question

court_in_question <- richest_courts[[1]][16]
case_richness_in_question <- case_richness_overall %>%
    filter(court == court_in_question) %>%
    select(id, federal_cite, slug, year, richness) %>%
    arrange(-richness) %>%
    head(5) %>%
    gt() %>%
    tab_header(title = paste("Top Cases - ", court_in_question)) %>%
    cols_label(id = "ID", federal_cite = "Federal Citation", slug = "slug", year = "Year", richness = "Richness")
case_richness_in_question

court_in_question <- richest_courts[[1]][17]
case_richness_in_question <- case_richness_overall %>%
    filter(court == court_in_question) %>%
    select(id, federal_cite, slug, year, richness) %>%
    arrange(-richness) %>%
    head(5) %>%
    gt() %>%
    tab_header(title = paste("Top Cases - ", court_in_question)) %>%
    cols_label(id = "ID", federal_cite = "Federal Citation", slug = "slug", year = "Year", richness = "Richness")
case_richness_in_question

court_in_question <- richest_courts[[1]][18]
case_richness_in_question <- case_richness_overall %>%
    filter(court == court_in_question) %>%
    select(id, federal_cite, slug, year, richness) %>%
    arrange(-richness) %>%
    head(5) %>%
    gt() %>%
    tab_header(title = paste("Top Cases - ", court_in_question)) %>%
    cols_label(id = "ID", federal_cite = "Federal Citation", slug = "slug", year = "Year", richness = "Richness")
case_richness_in_question

court_in_question <- richest_courts[[1]][19]
case_richness_in_question <- case_richness_overall %>%
    filter(court == court_in_question) %>%
    select(id, federal_cite, slug, year, richness) %>%
    arrange(-richness) %>%
    head(5) %>%
    gt() %>%
    tab_header(title = paste("Top Cases - ", court_in_question)) %>%
    cols_label(id = "ID", federal_cite = "Federal Citation", slug = "slug", year = "Year", richness = "Richness")
case_richness_in_question

court_in_question <- richest_courts[[1]][20]
case_richness_in_question <- case_richness_overall %>%
    filter(court == court_in_question) %>%
    select(id, federal_cite, slug, year, richness) %>%
    arrange(-richness) %>%
    head(5) %>%
    gt() %>%
    tab_header(title = paste("Top Cases - ", court_in_question)) %>%
    cols_label(id = "ID", federal_cite = "Federal Citation", slug = "slug", year = "Year", richness = "Richness")
case_richness_in_question

court_in_question <- richest_courts[[1]][21]
case_richness_in_question <- case_richness_overall %>%
    filter(court == court_in_question) %>%
    select(id, federal_cite, slug, year, richness) %>%
    arrange(-richness) %>%
    head(5) %>%
    gt() %>%
    tab_header(title = paste("Top Cases - ", court_in_question)) %>%
    cols_label(id = "ID", federal_cite = "Federal Citation", slug = "slug", year = "Year", richness = "Richness")
case_richness_in_question

court_in_question <- richest_courts[[1]][22]
case_richness_in_question <- case_richness_overall %>%
    filter(court == court_in_question) %>%
    select(id, federal_cite, slug, year, richness) %>%
    arrange(-richness) %>%
    head(5) %>%
    gt() %>%
    tab_header(title = paste("Top Cases - ", court_in_question)) %>%
    cols_label(id = "ID", federal_cite = "Federal Citation", slug = "slug", year = "Year", richness = "Richness")
case_richness_in_question

court_in_question <- richest_courts[[1]][23]
case_richness_in_question <- case_richness_overall %>%
    filter(court == court_in_question) %>%
    select(id, federal_cite, slug, year, richness) %>%
    arrange(-richness) %>%
    head(5) %>%
    gt() %>%
    tab_header(title = paste("Top Cases - ", court_in_question)) %>%
    cols_label(id = "ID", federal_cite = "Federal Citation", slug = "slug", year = "Year", richness = "Richness")
case_richness_in_question

court_in_question <- richest_courts[[1]][24]
case_richness_in_question <- case_richness_overall %>%
    filter(court == court_in_question) %>%
    select(id, federal_cite, slug, year, richness) %>%
    arrange(-richness) %>%
    head(5) %>%
    gt() %>%
    tab_header(title = paste("Top Cases - ", court_in_question)) %>%
    cols_label(id = "ID", federal_cite = "Federal Citation", slug = "slug", year = "Year", richness = "Richness")
case_richness_in_question

court_in_question <- richest_courts[[1]][25]
case_richness_in_question <- case_richness_overall %>%
    filter(court == court_in_question) %>%
    select(id, federal_cite, slug, year, richness) %>%
    arrange(-richness) %>%
    head(5) %>%
    gt() %>%
    tab_header(title = paste("Top Cases - ", court_in_question)) %>%
    cols_label(id = "ID", federal_cite = "Federal Citation", slug = "slug", year = "Year", richness = "Richness")
case_richness_in_question

```


## Individual Term Analyses

And finally, here are graphs for each individual word - both raw and relative counts.

```{r individual_terms}
zeros_table <- tibble(year = (1950:1974))

raw_count_graph <- function(term){
  dictionary_occurences_filt <- dictionary_occurrences %>%
    filter(phrase == term)
  
  pull_sum <- dictionary_occurences_filt %>%
    group_by(year) %>%
    summarise(count = n()) %>%
    right_join(zeros_table, by = "year") %>%
    mutate(count = replace_na(count, 0)) %>%
    arrange(year)
  
  raw_plot <- pull_sum %>%
    ggplot(aes(x = year, y = count)) +
    geom_line() +
    labs(title = paste("Occurrence of Term '", term, "' Over Time - Raw Count"), x = "Year", y = "Usage Count")
  
  print(raw_plot)
}

rel_count_graph <- function(term){
  dictionary_occurences_filt <- dictionary_occurrences %>%
    filter(phrase == term)
  
  overall_occurrences <- corpus_relevant %>%
    unnest_tokens(word, clean_text) %>%
    group_by(year) %>%
    summarise(count_ovr = n())
  
  pull_sum <- dictionary_occurences_filt %>%
    group_by(year) %>%
    summarise(count = n()) %>%
    right_join(overall_occurrences, by = "year") %>%
    arrange(year) %>%
    mutate(percent_occurr = 100*(count/count_ovr))
    
  pull_sum$percent_occurr[is.na(pull_sum$percent_occurr)] <- 0
  
  pull_sum <- pull_sum %>%
    select(year, percent_occurr)
    
  
  raw_plot <- pull_sum %>%
    ggplot(aes(x = year, y = percent_occurr)) +
    geom_line() +
    labs(title = paste("Occurrence of Term '", term, "' Over Time - Relative Count"), subtitle = "As Percentage of All Words in a Given Year", x = "Year", y = "Usage Percentage")
  
  print(raw_plot)
}


for(i in 1:nrow(dictionary_stemmed)){
  raw_count_graph(dictionary_stemmed[[1]][i])
  rel_count_graph(dictionary_stemmed[[1]][i])
}

  
    

```









